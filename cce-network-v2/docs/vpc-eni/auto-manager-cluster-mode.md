#### 2.3 自动规划集群模式
自动规划集群模式，即用户在创建集群时，不需要指定子网和 IP 地址范围（可以使用由 CCE 自动生成的地址范围）。系统会自动根据用户输入的节点规格和预期的 Pod 数量，自动规划出子网和 IP 地址范围。
在这种模式下，CCE 会根据用户加入的节点不同的地域，自动创建子网和 IP 地址范围，并在 IP 地址不足时，自动扩容创建新的子网。

> * 自动规划集群和托管集群之间的关系是什么？
* 是不是能把所有的托管集群都启用自动规划集群模式，进一步减少产品的复杂性，减少用户运维成本？

#### 2.3.1 自动规划集群模式的目标
自动规划集群的目的是提升CCE 的易用性，我们对自动规划集群的预期是：
* 用户可以快速创建集群，不需要再 CCE 上配置并关注网络的细节。
* 用户可以快速扩容集群，不需要再 CCE 上配置新的子网，并关注扩容时的网络细节。用户集群中预期不会出现 IP 地址不足的问题。
* 集群最大可以支持 5000 节点，集群最多支持 15000 个 Pod。
* 集群中所有的 Pod 和节点之间不会因为 ACL/安全组策略而无法通信。
* 自动规划集群支持与百度智能云上的其他所有网络产品的互联互通，如专线网关、NAT 网关等。自定义集群应拥有相同的扩展能力。

### 弹性网卡和 IP 地址容量的限制
* BCC实例与弹性网卡必须在同一可用区、同一VPC，可以在不同子网，挂载不同的安全组。
* 在一台实例上挂载多个弹性网卡不能提高实例内网带宽性能。
* 每个VPC可支持500个弹性网卡。如有需要，可以在配额中心申请提升配额。
* 单网卡上IP数量最少1个，最多40个。
* 云主机可挂载的弹性网卡数量为：当云主机cpu核数小于等于8时，最大可挂载的弹性网卡数量等于云主机cpu核数；当云主机cpu核数大于8时，最大可挂载8个弹性网卡
#### 每个弹性网卡可绑定 IP 地址数量和资源之间的关系
| 内存 |	IP数量| 
| --- | --- | 
| 1G |	2 |
| (1-8]G |	8 |
| (8-32]G |	16 |
| (32-64]G |	30 |
| 大于64G |	40 |

### 子网CIDR与Pod容量
每个子网都必须具有一个 IP 地址范围 CIDR。这是百度云用于为Pod、负载均衡器和节点分配 IP 地址的 IP 地址范围。创建子网后，您无法再缩小或更改子网的CIDR。
* 子网的 CIDR的第一 IP 地址和最后一个 IP 地址由百度智能云预留。
* ENI 的主 IP 也需要消耗子网中的一个 IP 地址，且 pod 无法直接使用该 IP 地址。

下表显示了在特定的子网主要 IP 地址范围大小情况下，您可以在所有使用该子网的集群中创建的最大Pod数。此表假定每个节点的 Pod 数上限为 128，这也是默认的 Pod 密度。

| 子网主要 IP 范围 | 最大 Pod 地址数|	最大节点数 | 最大 Pod 数量 |
| --- | --- |
| /24 次要范围分配方法由用户管理时的最小 Pod IP 范围 |	254 个地址 |1 个节点 |	128 个 Pod|
| /23
仅在次要范围分配方法由用户管理时可用 |	512 个地址 |	2 个节点 |	220 个 Pod |
| /22
仅在次要范围分配方法由用户管理时可用 |	1024 个地址	4 个节点 |	440 个地址 |
| /21
次要范围分配方法由 GKE 管理时的最小 Pod IP 范围 |	2048 个地址 |	8 个节点 |	880 个 Pod |
| /20 |	4096 个地址 |	16 个节点 |	1760 个 Pod |
| /19 |	8192 个地址 |	32 个节点	| 3520 个 Pod |
| /18 |	16384 个地址 |	64 个节点 |	7040 个 Pod |
| /17 |	32768 个地址 |	128 个节点 |	14080 个 Pod |
| /16 |	65536 个地址 |	256 个节点 |	28160 个 Pod |
| /15 |	131072 个地址 |	512 个节点 |	56320 个 Pod |
| /14
次要范围分配方法由 GKE 管理时用于 Pod 的子网次要 IP 范围的默认大小 |	262144 个地址 |	1024 个节点 |	112640 个 Pod |
| /13	| 524288 个地址	| 2048 个节点 |	225280 个 Pod |
| /12	| 1048576 个地址 |	4096 个节点	 | 450560 个 Pod |
| /11   |
2097152 个地址 |	8192 个节点 |	901120 个 Pod |

## 最佳实践
规划所需的 IP 地址配额。
根据需要使用非 RFC 1918 空间。
使用自定义子网模式。
规划每个节点的 pod 密度。
避免与其他环境中使用的 IP 地址重叠。
创建负载均衡器子网。
为集群自动扩缩器预留足够的 IP 地址空间。
在集群之间共享 IP 地址。
共享内部 LoadBalancer Service 的 IP 地址。